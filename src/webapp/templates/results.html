{% extends "base.html" %}

{% block title %}Prediction Results | Ensemble Based Multi Disease Prediction{% endblock %}

{% block content %}

<div class="container">

    <!-- ================= HEADER ================= -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">Prediction Results</h2>

        <a href="{{ url_for('download_report') }}" class="btn btn-outline-success">
            <i class="fa-solid fa-file-pdf"></i> Download Report
        </a>
    </div>

    <!-- ================= TOP DISEASE ================= -->
    <div class="alert alert-info text-center fw-semibold">
        Top Predicted Disease:
        <span class="text-danger fw-bold">
            {{ top_disease | capitalize }}
        </span>
    </div>

    <!-- ================= RESULTS TABLE ================= -->
    <div class="card shadow-sm mb-4">
        <div class="card-header fw-bold bg-light">
            Prediction Summary
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped mb-0 text-center">
                    <thead class="table-light">
                        <tr>
                            <th>Disease</th>
                            <th>Probability (%)</th>
                            <th>Prediction</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for disease, data in results.items() %}
                        <tr>
                            <td>{{ disease | capitalize }}</td>
                            <td>{{ (data.probability * 100) | round(2) }}</td>
                            <td>
                                {% if data.prediction == 1 %}
                                    <span class="badge bg-danger">Positive</span>
                                {% else %}
                                    <span class="badge bg-success">Negative</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="application/json" id="chart-data">
        {
        "labels": {{ labels | tojson }},
        "values": {{ values | tojson }}
        }
    </script>

    <!-- ================= CHARTS ================= -->
    <div class="row mb-4">

        <!-- BAR CHART -->
        <div class="col-md-6 mb-3">
            <div class="card shadow-sm">
                <div class="card-header fw-bold bg-light">
                    Disease Probability (Bar Chart)
                </div>
                <div class="card-body">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>

        <!-- LINE CHART -->
        <div class="col-md-6 mb-3">
            <div class="card shadow-sm">
                <div class="card-header fw-bold bg-light">
                    Disease Probability Trend (Line Chart)
                </div>
                <div class="card-body">
                    <canvas id="lineChart"></canvas>
                </div>
            </div>
        </div>

    </div>

    <!-- ================= EXPLAINABLE AI ================= -->
    <div class="card shadow-sm mb-4">
        <div class="card-header fw-bold bg-light">
            Explainable AI â€“ {{ top_disease | capitalize }} Prediction
        </div>

        <div class="card-body">
            <ul class="mb-0">
                {% for point in explanation_text %}
                    <li>{{ point }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>

</div>

{% endblock %}

{% block scripts %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const chartData = JSON.parse(
        document.getElementById("chart-data").textContent
    );

    const chartLabels = chartData.labels;
    const chartValues = chartData.values;

    new Chart(document.getElementById("barChart"), {
        type: "bar",
        data: {
            labels: chartLabels,
            datasets: [{
                label: "Probability (%)",
                data: chartValues,
                backgroundColor: "#0d6efd"
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true, max: 100 }
            }
        }
    });

    new Chart(document.getElementById("lineChart"), {
        type: "line",
        data: {
            labels: chartLabels,
            datasets: [{
                label: "Probability (%)",
                data: chartValues,
                borderColor: "#dc3545",
                tension: 0.3,
                fill: false
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true, max: 100 }
            }
        }
    });
</script>

{% endblock %}

